<script>
function drawTrains(trains, stations, xScale) {
    svg.selectAll(".train").remove();
    const trainGroup = svg.append("g").attr("class", "train");

    trains.forEach(train => {
        const pos = getTrainPosition(train, stations, xScale);
        if (pos === null) return;

        const y = train.direction === "up" ? height / 2 - 40 : height / 2 + 40;
        const isGray = parseInt(train.train_id) >= 30000;

        const padding = 10;
        const textElem = trainGroup.append("text")
            .attr("x", pos)
            .attr("y", y)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "middle")
            .attr("font-size", "12px")
            .text(train.train_name);

        const textWidth = textElem.node().getBBox().width + padding * 2;
        const textHeight = textElem.node().getBBox().height + padding;

        const xLeft = pos - textWidth / 2;
        const xRight = pos + textWidth / 2;
        const yTop = y - textHeight / 2;
        const yBottom = y + textHeight / 2;

        let points;
        if (train.direction === "up") {
            // 右に尖った四角形
            points = [
                [xLeft, yTop],
                [xRight - 8, yTop],
                [xRight, y],
                [xRight - 8, yBottom],
                [xLeft, yBottom]
            ];
        } else {
            // 左に尖った四角形
            points = [
                [xRight, yTop],
                [xLeft + 8, yTop],
                [xLeft, y],
                [xLeft + 8, yBottom],
                [xRight, yBottom]
            ];
        }

        trainGroup.insert("polygon", "text")
            .attr("points", points.map(p => p.join(",")).join(" "))
            .attr("fill", isGray ? "lightgray" : "white")
            .attr("stroke", "black")
            .attr("stroke-width", 1);
    });
}
</script>
