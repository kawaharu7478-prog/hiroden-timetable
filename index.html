<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>列車走行位置表示</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: sans-serif; }
    svg { background: #fff; }
    .station-label { font-size: 12px; text-anchor: middle; }
    .train-label { font-size: 12px; pointer-events: none; }
    .time-display { font-size: 16px; font-weight: bold; }
  </style>
</head>
<body>
  <div id="clock" class="time-display"></div>
  <svg id="chart" width="1000" height="300"></svg>

  <script>
    const svg = d3.select("#chart");
    const width = +svg.attr("width");
    const height = +svg.attr("height");

    // 駅リスト
    const stations = [
      "宮島口","阿品","阿品東","地御前","ＪＡ","宮内","廿市役","廿日市",
      "山陽","楽々園","佐伯区","五日市","修大協","井口","商工","草津南","草津",
      "古江","高須","東高須","西広島","福島町","西観音","観音町","天満町",
      "小網町","土橋","十日市","本川町","ドーム","紙屋西","紙屋東","立町",
      "八丁堀","胡町","銀山町","稲荷町","広島駅"
    ];

    // スケール
    const xScale = d3.scalePoint()
      .domain(stations)
      .range([50, width - 50]);

    const upLineY = height / 2 - 20;
    const downLineY = height / 2 + 20;

    // ライン（上下）
    svg.append("line")
      .attr("x1", 50).attr("x2", width - 50)
      .attr("y1", upLineY).attr("y2", upLineY)
      .attr("stroke", "black").attr("stroke-width", 2);

    svg.append("line")
      .attr("x1", 50).attr("x2", width - 50)
      .attr("y1", downLineY).attr("y2", downLineY)
      .attr("stroke", "black").attr("stroke-width", 2);

    // 駅名ラベル（中央）
    svg.selectAll(".station-label")
      .data(stations)
      .enter()
      .append("text")
      .attr("class", "station-label")
      .attr("x", d => xScale(d))
      .attr("y", height / 2)
      .attr("dy", "0.35em")
      .text(d => d);

    // 現在時刻表示
    function updateClock() {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      const ss = String(now.getSeconds()).padStart(2,"0");
      d3.select("#clock").text(`${hh}:${mm}:${ss}`);
    }
    setInterval(updateClock, 1000);
    updateClock();

    // CSV 読み込み
    const csvUrl = "YOUR_CSV_URL.csv"; // ←GitHub PagesのCSV URLに置き換える

    d3.csv(csvUrl).then(data => {
      // 時刻を分に変換
      data.forEach(d => {
        stations.forEach(s => {
          if (d[s]) {
            const [h, m] = d[s].split(":").map(Number);
            d[s] = h * 60 + m;
          } else {
            d[s] = null;
          }
        });
      });

      function interpolatePosition(train, nowMinutes) {
        let prevStation = null, nextStation = null;
        let prevTime = null, nextTime = null;

        for (let i = 0; i < stations.length; i++) {
          const t = train[stations[i]];
          if (t !== null && t <= nowMinutes) {
            prevStation = stations[i];
            prevTime = t;
          }
          if (t !== null && t > nowMinutes) {
            nextStation = stations[i];
            nextTime = t;
            break;
          }
        }

        if (!prevStation || !nextStation) return null;

        const ratio = (nowMinutes - prevTime) / (nextTime - prevTime);
        const x = xScale(prevStation) + (xScale(nextStation) - xScale(prevStation)) * ratio;
        return { x, station: prevStation, nextStation };
      }

      function updateTrains() {
        const now = new Date();
        const nowMinutes = now.getHours() * 60 + now.getMinutes() + now.getSeconds()/60;

        const trains = data.map(train => {
          const pos = interpolatePosition(train, nowMinutes);
          return pos ? { ...train, pos } : null;
        }).filter(d => d !== null);

        const g = svg.selectAll(".train")
          .data(trains, d => d.train_id);

        const gEnter = g.enter().append("g").attr("class","train");

        gEnter.append("rect");
        gEnter.append("polygon");
        gEnter.append("text").attr("class","train-label");

        const gAll = gEnter.merge(g);

        gAll.each(function(d){
          const baseY = d.direction === "up" ? upLineY : downLineY;
          const rectWidth = 40, rectHeight = 20;
          const rectX = d.pos.x - rectWidth/2;
          const rectY = baseY - rectHeight - 5;

          const fillColor = d.train_id >= 30000 ? "lightgray" : "white";
          const strokeColor = "black";

          d3.select(this).select("rect")
            .attr("x", rectX)
            .attr("y", rectY)
            .attr("width", rectWidth)
            .attr("height", rectHeight)
            .attr("fill", fillColor)
            .attr("stroke", strokeColor);

          // 矢印（三角形）
          const arrowSize = 10;
          let points;
          if (d.direction === "up") {
            points = [
              [rectX + rectWidth, rectY],
              [rectX + rectWidth + arrowSize, rectY + rectHeight/2],
              [rectX + rectWidth, rectY + rectHeight]
            ];
          } else {
            points = [
              [rectX, rectY],
              [rectX - arrowSize, rectY + rectHeight/2],
              [rectX, rectY + rectHeight]
            ];
          }
          d3.select(this).select("polygon")
            .attr("points", points.map(p => p.join(",")).join(" "))
            .attr("fill", fillColor)
            .attr("stroke", strokeColor);

          // 列車名
          d3.select(this).select("text")
            .attr("x", d.pos.x)
            .attr("y", rectY + rectHeight/2 + 4)
            .attr("text-anchor", "middle")
            .text(d.train_name);
        });

        g.exit().remove();
      }

      setInterval(updateTrains, 1000);
      updateTrains();
    });
  </script>
</body>
</html>
